<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Phaser Multiplayer Shooter</title>

<script src="https://cdn.jsdelivr.net/npm/phaser@3/dist/phaser.js"></script>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
import { 
    getDatabase, 
    ref, 
    set, 
    push,
    remove,
    update,
    onValue, 
    onDisconnect,
    runTransaction
} from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

/* ================= FIREBASE CONFIG ================= */

const firebaseConfig = {
  apiKey: "AIzaSyC77CXjhgwuiNqS9QxOHd8Tf8SPwEzFoHM",
  authDomain: "phaser-multiplayer-game-52eaa.firebaseapp.com",
  databaseURL: "https://phaser-multiplayer-game-52eaa-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "phaser-multiplayer-game-52eaa",
  storageBucket: "phaser-multiplayer-game-52eaa.firebasestorage.app",
  messagingSenderId: "902358290008",
  appId: "1:902358290008:web:685e8d667957a9537e842d"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const database = getDatabase(app);

/* ================= GLOBAL ================= */

let playerId;
let playerName;
let localPlayer;
let cursors;
let mousePointer;
let walls;
let bulletGroup;
let otherPlayers = {};
let playerHP = 5;
let isDead = false;
let lastHitBy = null;
let score = 0;

let lastCombatTime = 0;
let regenTimer = 0;
let grenadeCooldown = false;

let hpText;
let scoreText;
let leaderboardText;

let networkTimer = 0;
const NETWORK_RATE = 100;

/* ================= LOGIN ================= */

async function login() {
    const user = await signInAnonymously(auth);
    playerId = user.user.uid;
}

/* ================= MENU ================= */

function createMenu() {
    const div = document.createElement("div");
    div.style.position="absolute";
    div.style.top="50%";
    div.style.left="50%";
    div.style.transform="translate(-50%,-50%)";

    const input=document.createElement("input");
    input.placeholder="Enter name";

    const btn=document.createElement("button");
    btn.innerText="Join";

    btn.onclick=()=>{
        playerName=input.value.trim();
        if(!playerName) return alert("Enter name");
        div.remove();
        startGame();
    };

    div.append(input,document.createElement("br"),document.createElement("br"),btn);
    document.body.appendChild(div);
}

/* ================= START ================= */

function startGame(){

    new Phaser.Game({
        type:Phaser.AUTO,
        width:1200,
        height:800,
        physics:{ default:"arcade", arcade:{ debug:false } },
        scene:{ preload,create,update:gameUpdate }
    });
}

/* ================= CREATE ================= */

function preload(){}

function create(){

    this.physics.world.setBounds(0,0,3000,3000);
    this.cameras.main.setBounds(0,0,3000,3000);

    /* BULLET TEXTURE */

    const g = this.add.graphics();
    g.fillStyle(0xffff00,1);
    g.fillCircle(8,8,8);
    g.generateTexture('bulletTexture',16,16);
    g.destroy();

    /* PLAYER */

    const playerColor = Phaser.Display.Color.RandomRGB().color;

    localPlayer=this.add.rectangle(400,300,32,32,playerColor);
    this.physics.add.existing(localPlayer);
    localPlayer.body.setCollideWorldBounds(true);
    this.cameras.main.startFollow(localPlayer);

    cursors=this.input.keyboard.addKeys("W,A,S,D");
    mousePointer=this.input.activePointer;
    this.input.on("pointerdown",()=>shoot());

    this.input.keyboard.on("keydown-G",()=>throwGrenade());

    /* WALLS */

    walls=this.physics.add.staticGroup();

    const createWall=(x,y,w,h)=>{
        const wall=this.add.rectangle(x,y,w,h,0x444444);
        this.physics.add.existing(wall,true);
        walls.add(wall);
    };

    createWall(600,600,500,40);
    createWall(1200,900,40,600);
    createWall(1800,1500,700,40);
    createWall(2400,2000,40,800);
    createWall(800,2200,400,40);
    createWall(1500,500,300,40);
    createWall(2600,1000,500,40);
    createWall(1000,1700,40,500);

    this.physics.add.collider(localPlayer,walls);

    /* BULLETS */

    bulletGroup = this.physics.add.group();

    this.physics.add.collider(bulletGroup, walls, (bullet)=>{
        remove(ref(database,"bullets/"+bullet.firebaseId));
    });

    /* TRAIL */

    const particles = this.add.particles('bulletTexture');
    particles.setBlendMode(Phaser.BlendModes.ADD);

    /* UI */

    hpText=this.add.text(20,20,"HP:5",{fontSize:"22px"}).setScrollFactor(0);
    scoreText=this.add.text(20,50,"Score:0",{fontSize:"22px"}).setScrollFactor(0);
    leaderboardText=this.add.text(1000,20,"",{fontSize:"18px"}).setScrollFactor(0);

    /* FIREBASE PLAYER */

    const playerRef=ref(database,"players/"+playerId);

    set(playerRef,{
        name:playerName,
        x:400,
        y:300,
        hp:5,
        alive:true,
        score:0,
        color:playerColor
    });

    onDisconnect(playerRef).remove();

    /* PLAYERS SYNC */

    onValue(ref(database,"players"),snapshot=>{
        const players=snapshot.val();
        if(!players) return;

        const sorted = Object.values(players)
            .sort((a,b)=> (b.score||0)-(a.score||0))
            .slice(0,10);

        let text="TOP 10\n";
        sorted.forEach(p=>{
            text+=p.name+" : "+(p.score||0)+"\n";
        });
        leaderboardText.setText(text);

        for(let id in otherPlayers){
            if(!players[id]){
                otherPlayers[id].destroy();
                delete otherPlayers[id];
            }
        }

        for(let id in players){

            if(id===playerId){
                score = players[id].score || 0;
                continue;
            }

            const data=players[id];

            if(!otherPlayers[id]){
                otherPlayers[id]=this.add.rectangle(
                    data.x,data.y,32,32,
                    data.alive?data.color:0x555555
                );
            }

            otherPlayers[id].x=data.x;
            otherPlayers[id].y=data.y;
            otherPlayers[id].setFillStyle(data.alive?data.color:0x555555);
        }
    });

    /* BULLET SYNC */

    onValue(ref(database,"bullets"),snapshot=>{
        const data=snapshot.val();
        if(!data) return;

        bulletGroup.clear(true,true);

        for(let id in data){

            const b=bulletGroup.create(data[id].x,data[id].y,'bulletTexture');
            b.setScale(0.8);
            b.body.setAllowGravity(false);
            b.body.setCircle(8);
            b.body.velocity.x=data[id].vx;
            b.body.velocity.y=data[id].vy;
            b.owner=data[id].owner;
            b.firebaseId=id;

            particles.startFollow(b,0,0,1);
        }
    });

    /* GRENADE SYNC */

    onValue(ref(database,"grenades"),snapshot=>{
        const data=snapshot.val();
        if(!data) return;

        for(let id in data){

            const g=data[id];

            const circle=this.add.circle(g.x,g.y,60,0xff0000,0.3);

            this.time.delayedCall(300,()=>{

                if(g.owner!==playerId && playerHP>0){

                    const dist=Phaser.Math.Distance.Between(
                        g.x,g.y,
                        localPlayer.x,localPlayer.y
                    );

                    if(dist<60){
                        playerHP--;
                        lastCombatTime=this.time.now;
                        if(playerHP<=0) handleDeath();
                    }
                }

                circle.destroy();
            });
        }
    });
}

/* ================= SHOOT ================= */

function shoot(){

    if(playerHP<=0) return;

    lastCombatTime = performance.now();

    const speed=600;
    const dx=mousePointer.worldX-localPlayer.x;
    const dy=mousePointer.worldY-localPlayer.y;
    const len=Math.sqrt(dx*dx+dy*dy);

    const vx=(dx/len)*speed;
    const vy=(dy/len)*speed;

    const bulletRef=push(ref(database,"bullets"));

    set(bulletRef,{
        owner:playerId,
        x:localPlayer.x,
        y:localPlayer.y,
        vx,vy
    });

    setTimeout(()=>remove(bulletRef),2000);
}

/* ================= GRENADE ================= */

function throwGrenade(){

    if(grenadeCooldown || playerHP<=0) return;

    grenadeCooldown=true;

    const grenadeRef=push(ref(database,"grenades"));

    set(grenadeRef,{
        owner:playerId,
        x:mousePointer.worldX,
        y:mousePointer.worldY
    });

    setTimeout(()=>remove(grenadeRef),1000);
    setTimeout(()=>grenadeCooldown=false,3000);
}

/* ================= DEATH ================= */

function handleDeath(){

    if(isDead) return;

    isDead=true;

    localPlayer.scene.tweens.add({
        targets: localPlayer,
        angle:180,
        scale:0,
        duration:800
    });

    update(ref(database,"players/"+playerId),{ alive:false });

    setTimeout(()=>{

        playerHP=5;
        isDead=false;
        localPlayer.setScale(1);
        localPlayer.setAngle(0);
        localPlayer.x=400;
        localPlayer.y=300;

        if(lastHitBy){

            const killerScoreRef = ref(database,"players/"+lastHitBy+"/score");

            runTransaction(killerScoreRef,(current)=>{
                return (current||0)+1;
            });
        }

        lastHitBy=null;

        update(ref(database,"players/"+playerId),{
            x:400,
            y:300,
            hp:5,
            alive:true
        });

    },3000);
}

/* ================= UPDATE ================= */

function gameUpdate(time,delta){

    localPlayer.body.setVelocity(0);

    if(playerHP>0){
        if(cursors.A.isDown) localPlayer.body.setVelocityX(-300);
        if(cursors.D.isDown) localPlayer.body.setVelocityX(300);
        if(cursors.W.isDown) localPlayer.body.setVelocityY(-300);
        if(cursors.S.isDown) localPlayer.body.setVelocityY(300);
    }

    bulletGroup.getChildren().forEach(bullet=>{

        if(bullet.owner===playerId) return;
        if(playerHP<=0) return;

        const dist=Phaser.Math.Distance.Between(
            bullet.x,bullet.y,
            localPlayer.x,localPlayer.y
        );

        if(dist<20){

            lastHitBy=bullet.owner;
            playerHP--;
            lastCombatTime=time;

            remove(ref(database,"bullets/"+bullet.firebaseId));

            if(playerHP<=0){
                handleDeath();
            }
        }
    });

    /* HP REGEN */

    if(playerHP>0 && playerHP<5){

        if(time-lastCombatTime>7000){

            regenTimer+=delta;

            if(regenTimer>=3000){
                playerHP++;
                regenTimer=0;
            }
        }
    }

    hpText.setText("HP:"+playerHP);
    scoreText.setText("Score:"+score);

    networkTimer+=delta;

    if(networkTimer>=NETWORK_RATE){
        networkTimer=0;
        update(ref(database,"players/"+playerId),{
            x:localPlayer.x,
            y:localPlayer.y,
            hp:playerHP,
            score:score
        });
    }
}

/* INIT */

await login();
createMenu();

</script>
</head>
<body style="margin:0; overflow:hidden;"></body>
</html>
